- hosts: uci-cpu1  # Replace with your specific CPU node hostname
  tasks:
  # =======================================================
  # 1. Reset Config to Defaults (Removes Nvidia Runtime)
  # =======================================================
  - name: Reset containerd config to default (removes nvidia settings)
    ansible.builtin.shell: |
      containerd config default > /etc/containerd/config.toml
    become: true

  # =======================================================
  # 2. Re-apply Mandatory Kubernetes Settings
  # =======================================================
  - name: Enable SystemdCgroup (Required for K8s)
    ansible.builtin.replace:
      path: /etc/containerd/config.toml
      regexp: 'SystemdCgroup = false'
      replace: 'SystemdCgroup = true'
    become: true

  # =======================================================
  # 3. Restart and Verify
  # =======================================================
  - name: Restart containerd
    ansible.builtin.systemd:
      name: containerd
      state: restarted
      daemon_reload: true
    become: true

  - name: Verify default runtime is NOT nvidia
    ansible.builtin.shell: crictl info | grep -oP '"defaultRuntimeName":\s*"\K[^"]+'
    register: verify_runtime
    changed_when: false
    become: true

  - name: Display runtime (Should be 'runc')
    ansible.builtin.debug:
      msg: "Current runtime: {{ verify_runtime.stdout }}"
