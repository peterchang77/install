- hosts: [uci-h100-1, uci-a100-1] 
  tasks:
  # =======================================================
  # Stage 1: Reset Configuration to Clean Defaults
  # =======================================================
  - name: Backup broken config (just in case)
    ansible.builtin.copy:
      src: /etc/containerd/config.toml
      dest: /etc/containerd/config.toml.broken.{{ ansible_date_time.epoch }}
      remote_src: yes
    become: true
    ignore_errors: true

  - name: Generate fresh default config
    ansible.builtin.shell: |
      containerd config default > /etc/containerd/config.toml
    become: true

  # =======================================================
  # Stage 2: Apply Mandatory Kubernetes Settings
  # =======================================================
  - name: Enable SystemdCgroup (Required for K8s)
    ansible.builtin.replace:
      path: /etc/containerd/config.toml
      regexp: 'SystemdCgroup = false'
      replace: 'SystemdCgroup = true'
    become: true

  # =======================================================
  # Stage 3: Configure Nvidia Runtime (Using ctk)
  # =======================================================
  # We use nvidia-ctk because it automatically handles the Schema Version (v2 vs v3)
  # preventing the "mixed section" errors you saw.
  - name: Configure Nvidia Runtime
    ansible.builtin.shell: |
      nvidia-ctk runtime configure --runtime=containerd --set-as-default
    become: true

  # =======================================================
  # Stage 4: Restart and Verify
  # =======================================================
  - name: Restart containerd
    ansible.builtin.systemd:
      name: containerd
      state: restarted
      daemon_reload: true
    become: true

  - name: Wait for containerd socket
    ansible.builtin.wait_for:
      path: /var/run/containerd/containerd.sock
      state: present
      timeout: 30
    become: true

  - name: Verify Default Runtime
    ansible.builtin.shell: crictl info | grep -oP '"defaultRuntimeName":\s*"\K[^"]+'
    register: verify_runtime
    changed_when: false
    become: true

  - name: Display Status
    ansible.builtin.debug:
      msg: "Runtime verified: {{ verify_runtime.stdout }}"
    failed_when: verify_runtime.stdout != "nvidia"
