# ======================================================================================
# INITIALIZE K8 CLUSTER WORKERS
# ======================================================================================
#
# (1) Determine k8 master token
#
# $ kubeadm token list
#
# (2) Determine k8 master hash
#
# $ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
#
# $ export K8_HASH=...
# $ export K8_TOKEN=...
#
# (3) Determine k8 master IP address / port
#
# $ export K8_HOST=...
# $ export K8_PORT=...
#
# ======================================================================================

- hosts: workers 
  vars:
    k8_host: "{{ lookup('env', 'K8_HOST') }}"
    k8_port: "{{ lookup('env', 'K8_PORT') }}"
    k8_token: "{{ lookup('env', 'K8_TOKEN') }}"
    k8_hash: "{{ lookup('env', 'K8_HASH') }}"
  tasks:
  - name: Reset existing configurations 
    shell: "kubeadm reset -f"
    become: true
    become_method: sudo
  - name: Stop kubelet 
    systemd:
      state: stopped
      name: kubelet
    become: true
    become_method: sudo
  - name: Remove /var/lib/cni
    file:
      path: /var/lib/cni
      state: absent
    become: true
    become_method: sudo
  - name: Remove /var/lib/calico
    file:
      path: /var/lib/calico
      state: absent
    become: true
    become_method: sudo
  - name: Remove /etc/cni
    file:
      path: /etc/cni
      state: absent
    become: true
    become_method: sudo
  - name: Bring down cni0
    shell: "if ip link show cni0 >/dev/null 2>&1; then ip link set cni0 down; ip link delete cni0; fi"
    become: true
    become_method: sudo
  - name: Bring down tunl0 (Calico)
    shell: "if ip link show tunl0 >/dev/null 2>&1; then ip link set tunl0 down; fi"
    become: true
    become_method: sudo
  - name: Start kubelet 
    systemd:
      state: started 
      name: kubelet
    become: true
    become_method: sudo
  - name: Start containerd 
    systemd:
      state: started 
      name: containerd
    become: true
    become_method: sudo
  - name: Wait for containerd socket to be available
    wait_for:
      path: /var/run/containerd/containerd.sock
      state: present
      timeout: 30
    become: true
  - name: Wait for containerd to be ready
    shell: crictl info
    register: containerd_info
    until: containerd_info.rc == 0
    retries: 10
    delay: 3
    become: true
  - name: Initialize worker 
    shell: kubeadm join --token {{ k8_token }} {{ k8_host }}:{{ k8_port }} --discovery-token-ca-cert-hash sha256:{{ k8_hash }}
    become: true
    become_method: sudo
