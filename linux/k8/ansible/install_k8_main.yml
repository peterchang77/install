- hosts: all 
  tasks:
  # =======================================================
  # Stage 1: Install Docker with NVIDIA GPU Support
  # =======================================================
  - name: Ensure Docker repository file is absent
    ansible.builtin.file:
      path: /etc/apt/sources.list.d/docker.list
      state: absent
    become: true

  - name: Ensure Docker keyring is absent (clean start)
    ansible.builtin.file:
      path: /etc/apt/keyrings/docker.gpg
      state: absent
    become: true

  - name: Ensure NVIDIA repository file is absent
    ansible.builtin.file:
      path: /etc/apt/sources.list.d/nvidia-container-toolkit.list
      state: absent
    become: true

  - name: Install prerequisites
    apt:
      name:
      - ca-certificates
      - curl
      - gnupg
      state: present
      update_cache: true
    become: true

  - name: Create Docker GPG keyring directory
    ansible.builtin.file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'
    become: true

  - name: Download Docker GPG key (Armor)
    ansible.builtin.get_url:
      url: https://download.docker.com/linux/ubuntu/gpg
      dest: /tmp/docker.asc
      mode: '0644'
      force: yes
    become: true

  - name: Dearmor Docker GPG key
    shell: |
      gpg --dearmor -o /etc/apt/keyrings/docker.gpg /tmp/docker.asc
    args:
      creates: /etc/apt/keyrings/docker.gpg
    become: true

  - name: Set Docker GPG key permissions
    ansible.builtin.file:
      path: /etc/apt/keyrings/docker.gpg
      mode: '0644'
    become: true

  - name: Get Ubuntu version codename
    shell: . /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}"
    register: ubuntu_codename
    changed_when: false

  - name: Get system architecture
    shell: dpkg --print-architecture
    register: system_arch
    changed_when: false

  - name: Add Docker repository
    ansible.builtin.lineinfile:
      path: /etc/apt/sources.list.d/docker.list
      line: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ubuntu_codename.stdout }} stable"
      state: present
      create: yes
    become: true

  - name: Update apt cache
    apt:
      update_cache: true
    become: true

  - name: Install Docker and containerd
    apt:
      name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
      state: present
    become: true

  - name: Generate default containerd config
    shell: mkdir -p /etc/containerd && containerd config default > /etc/containerd/config.toml
    become: true

  - name: Configure containerd - comment out disabled_plugins
    ansible.builtin.lineinfile:
      path: /etc/containerd/config.toml
      regexp: 'disabled_plugins = \["cri"\]'
      line: '# disabled_plugins = ["cri"]'
      state: present
      create: yes
    become: true

  - name: Configure containerd - set SystemdCgroup = true
    ansible.builtin.replace:
      path: /etc/containerd/config.toml
      regexp: 'SystemdCgroup = false'
      replace: 'SystemdCgroup = true'
    become: true

  - name: Restart containerd
    systemd:
      name: containerd
      state: restarted
      daemon_reload: true
    become: true

  - name: Install NVIDIA Container Toolkit prerequisites
    apt:
      name:
      - curl
      state: present
    become: true

  - name: Download NVIDIA GPG key (Armor)
    ansible.builtin.get_url:
      url: https://nvidia.github.io/libnvidia-container/gpgkey
      dest: /tmp/nvidia.asc
      mode: '0644'
      force: yes
    become: true

  - name: Dearmor NVIDIA GPG key
    shell: |
      gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg /tmp/nvidia.asc
    args:
      creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    become: true

  - name: Set NVIDIA GPG key permissions
    ansible.builtin.file:
      path: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      mode: '0644'
    become: true

  - name: Add NVIDIA Container Toolkit repository
    shell: |
      curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
      sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
      tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
    become: true

  - name: Update apt cache for NVIDIA repo
    apt:
      update_cache: true
    become: true

  - name: Install NVIDIA Container Toolkit
    apt:
      name:
      - nvidia-container-toolkit
      - nvidia-container-toolkit-base
      - libnvidia-container-tools
      - libnvidia-container1
      state: present
    become: true

  - name: Configure Docker daemon for systemd cgroup
    copy:
      dest: /etc/docker/daemon.json
      content: |
        {
          "exec-opts": ["native.cgroupdriver=systemd"],
          "log-driver": "json-file",
          "log-opts": {
            "max-size": "100m"
          },
          "storage-driver": "overlay2"
        }
    become: true

  - name: Configure NVIDIA runtime for Docker
    shell: nvidia-ctk runtime configure --runtime=docker
    become: true

  - name: Configure NVIDIA runtime for containerd
    shell: nvidia-ctk runtime configure --runtime=containerd
    become: true

  - name: Enable no-cgroups in NVIDIA config
    ansible.builtin.lineinfile:
      path: /etc/nvidia-container-runtime/config.toml
      regexp: '^#?no-cgroups'
      line: 'no-cgroups = false'
      state: present
    become: true

  - name: Restart containerd to apply NVIDIA config
    systemd:
      name: containerd
      state: restarted
      daemon_reload: true
    become: true

  - name: Start and enable Docker
    systemd:
      name: docker
      state: started
      enabled: yes
      daemon_reload: true
    become: true

  # =======================================================
  # Stage 2: Install Kubernetes
  # =======================================================
  - name: Load kernel modules for K8s
    community.general.modprobe:
      name: "{{ item }}"
      state: present
    loop:
      - overlay
      - br_netfilter
    become: true

  - name: Configure kernel modules to load on boot
    ansible.builtin.lineinfile:
      path: /etc/modules-load.d/k8s.conf
      line: "{{ item }}"
      state: present
      create: yes
    loop:
      - overlay
      - br_netfilter
    become: true

  - name: Configure sysctl parameters for K8s
    ansible.builtin.lineinfile:
      path: /etc/sysctl.d/k8s.conf
      line: "{{ item }}"
      state: present
      create: yes
    loop:
      - "net.bridge.bridge-nf-call-iptables = 1"
      - "net.bridge.bridge-nf-call-ip6tables = 1"
      - "net.ipv4.ip_forward = 1"
    become: true

  - name: Apply sysctl parameters
    shell: sysctl --system
    become: true

  - name: Install packages for Kubernetes apt repository
    apt:
      name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
      state: present
    become: true

  - name: Create Kubernetes GPG keyring directory
    ansible.builtin.file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'
    become: true

  - name: Download Kubernetes GPG key (Armor)
    ansible.builtin.get_url:
      url: https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key
      dest: /tmp/k8s.asc
      mode: '0644'
      force: yes
    become: true

  - name: Dearmor Kubernetes GPG key
    shell: |
      gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg /tmp/k8s.asc
    args:
      creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    become: true

  - name: Set Kubernetes GPG key permissions
    ansible.builtin.file:
      path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      mode: '0644'
    become: true

  - name: Add Kubernetes repository
    ansible.builtin.lineinfile:
      path: /etc/apt/sources.list.d/kubernetes.list
      line: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /"
      state: present
      create: yes
    become: true

  - name: Update apt cache for Kubernetes
    apt:
      update_cache: true
    become: true

  - name: Disable swap
    shell: swapoff -a
    become: true

  - name: Disable swap in /etc/fstab
    ansible.builtin.replace:
      path: /etc/fstab
      regexp: '^([^#].*?\sswap\s+.*)$'
      replace: '# \1'
    become: true

  - name: Install Kubernetes packages
    apt:
      name:
      - kubelet
      - kubeadm
      - kubectl
      state: present
    become: true

  - name: Hold Kubernetes packages to prevent auto-upgrade
    shell: apt-mark hold kubelet kubeadm kubectl
    become: true

  - name: Start and enable kubelet
    systemd:
      name: kubelet
      state: started
      enabled: yes
      daemon_reload: true
    become: true
